# 全自动任务执行指南

本文档说明如何让 Claude Code 全自动完成任务，无需人工干预。

---

## 🎯 核心原理

Claude Code 需要明确的指令才能自动执行。要实现全自动，需要：

1. **明确的任务描述**：具体的目标和验收标准
2. **完整的上下文**：相关文件、代码位置、问题分析
3. **授权执行**：明确告知可以直接修改代码
4. **验证方法**：如何确认任务完成

---

## 📋 方法一：使用任务清单 + 单次指令

### 步骤 1：准备任务清单
已完成：`docs/TASK_LIST.md`

### 步骤 2：发送全自动执行指令

```
请按照 docs/TASK_LIST.md 中的任务清单，自动完成所有 P0 和 P1 任务。

要求：
1. 直接修改代码，无需询问我的确认
2. 每完成一个任务，运行验证测试
3. 如果遇到问题，记录到日志并继续下一个任务
4. 完成后生成执行报告

你有完全的代码修改权限，请开始执行。
```

---

## 📋 方法二：使用 Codex MCP 工具（推荐）

根据你的 CLAUDE.md 配置，你已经集成了 Codex MCP。这是最强大的自动化方式。

### 完整指令模板

```
请使用 Codex MCP 工具完成以下任务：

1. 读取 docs/TASK_LIST.md 中的所有 P0 任务
2. 对每个任务：
   - 分析涉及的文件和代码位置
   - 生成修复代码（unified diff patch）
   - 应用修复
   - 运行验证测试
3. 生成执行报告，包括：
   - 已完成的任务列表
   - 修改的文件清单
   - 测试结果
   - 遇到的问题（如有）

要求：
- 使用 sandbox="workspace-write" 模式
- 直接修改代码，无需我的确认
- 如果某个任务失败，继续执行下一个
- 保持代码风格一致

开始执行。
```

---

## 📋 方法三：分阶段自动执行

如果任务较多，可以分阶段执行：

### 阶段 1：P0 任务（紧急）

```
请自动完成 docs/TASK_LIST.md 中的所有 P0 任务：

P0-1: 修复 usage_cache 过期时间格式
P0-2: 修复 UI 更新 provider 同步

要求：
1. 使用方案 A（epoch 毫秒）修复 P0-1
2. 按照任务清单中的解决方案修改代码
3. 每个任务完成后运行验证测试
4. 生成 git commit（commit message 包含任务编号）

你有完全的代码修改权限，直接执行，无需询问。
```

### 阶段 2：P1 任务（高优先级）

```
P0 任务已完成，现在请自动完成所有 P1 任务：

P1-1: 增加 busy_timeout
P1-2: 原子更新 error_count
P1-3: 合并事务
P1-4: 增加 maintenance 调度

要求同上，直接执行。
```

---

## 🔧 方法四：使用 EnterPlanMode（适合复杂任务）

对于需要架构调整的任务（如 P2-3），可以先规划：

```
请进入 Plan Mode，为以下任务制定实施计划：

任务：实现 usage 写入降频策略（P2-3）

要求：
1. 分析当前写入频率和性能瓶颈
2. 设计内存聚合 + 定期 flush 方案
3. 评估对现有代码的影响
4. 提供详细的实施步骤

规划完成后，如果我批准，请自动执行实施。
```

---

## ⚙️ 关键配置：授权自动执行

### 在 CLAUDE.md 中添加项目级授权

在你的 `.claude/CLAUDE.md` 或项目根目录的 `CLAUDE.md` 中添加：

```markdown
## 项目自动化授权

对于以下类型的任务，Claude Code 有完全的自动执行权限：

### 允许自动执行的操作
- 修复 docs/TASK_LIST.md 中标记的 bug
- 实施 docs/sqlite-implementation-analysis.md 中的优化建议
- 添加单元测试
- 更新文档
- 代码格式化和 lint 修复

### 需要人工确认的操作
- 删除功能或 API
- 修改数据库 schema（需要迁移脚本）
- 修改配置文件的默认值
- 涉及安全性的更改

### 自动执行规范
1. 每次修改后运行相关测试
2. 保持代码风格一致
3. 添加必要的注释
4. 生成清晰的 commit message
5. 如果测试失败，回滚更改并报告
```

---

## 🚀 最佳实践：完整的自动化工作流

### 示例：完整的 P0 任务自动化

```
我需要你完全自动地完成 SQLite P0 任务修复，以下是完整指令：

## 任务目标
修复 docs/TASK_L-1 和 P0-2 任务

## 执行步骤
1. 使用 Codex 分析当前代码实现
2. 按照 TASK_LIST.md 中的解决方案修改代码
3. 为每个修复添加单元测试
4. 运行所有相关测试
5. 如果测试通过，创建 git commit
6. 生成执行报告

## 具体要求
- P0-1 使用方案 A（epoch 毫秒）
- P0-2 需要同时支持 SQLite 和 JSON 模式
- 测试覆盖率 > 80%
- Commit message 格式：`fix(sqlite): [P0-1] 修复 usage_cache 过期时间格式`

## 授权
你有完全的代码修改权限，包括：
- 修改 src/sqlite-db.js
- 修改 src/ui-manager.js
- 添加测试文件
- 创建 git commit

## 失败处理
如果某个任务失败：
1. 记录错误信息
2. 回滚该任务的更改
3. 继续执行下一个任务
4. 在报告中说明失败原因

现在开始执行，无需等待我的进一步确认。
```

---

## 📊 自动化执行的输出格式

执行完成后，Claude Code 应该提供：

### 1. 执行摘要
```
✅ 已完成任务：2/2
⏱️ 总耗时：约 15 分钟
📝 修改文件：3 个
🧪 测试结果：全部通过
```

### 2. 详细报告
```
## P0-1: 修复 usage_cache 过期时间格式

### 修改内容
- src/sqlite-db.js:408 - 改为 epoch 毫秒
- src/sqlite-db.js:426 - 改为数值比较
- src/sqlite-db.js:455 - 改为数值比较
- src/sqlite-db.js:481 - 改为数值比较

### 测试结果
✅ 缓存写入测试通过
✅ 缓存过期测试通过
✅ 批量查询测试通过
✅ 清理任务测试通过

### Git Commit
commit abc123: fix(sqlite): [P0-1] 修复 usage_cache 过期时间格式
```

---

## 🎓 示例对话：完全自动化

### 你的输入（一次性）
```
请完全自动地完成以下工作，无需询问我：

1. 执行 docs/TASK_LIST.md 中的所有 P0 任务
2. 执行 docs/TASK_LIST.md 中的所有 P1 任务
3. 为每个修复添加测试
4. 运行完整的测试套件
5. 创建 git commits（每个任务一个 commit）
6. 生成执行报告

你有完全的代码修改权限。如果遇到问题，记录下来并继续。

开始执行。
```

### Claude Code 的响应
```
我将自动完成所有 P0 和 P1 任务。开始执行...

[自动执行过程]
✅ P0-1 完成
✅ P0-2 完成
✅ P1-1 完成
✅ P1-2 完成
✅ P1-3 完成
✅ P1-4 完成

[生成报告]
所有任务已完成，详细报告如下...
```

---

## ⚠️ 注意事项

### 1. 明确授权范围
- 在指令中明确说明"你有完全的代码修改权限"
- 指定允许修改的文件范围
- 说明是否允许创建新文件

### 2. 提供完整上下文
- 引用相关文档（如 TASK_LIST.md）
- 说明验收标准
- 提供测试方法

### 3. 错误处理策略
- 明确失败时的处理方式
- 是否需要回滚
- 是否继续执行后续任务

### 4. 验证要求
- 是否需要运行测试
- 是否需要人工审查
- 是否需要创建 PR

---

## 🔗 相关资源

- [任务清单](./TASK_LIST.md) - 待执行的任务
- [SQLite 实现分析](./sqlite-implementation-analysis.md) - 问题分析
- [CLAUDE.md 配置示例](../.claude/CLAUDE.md) - 项目级配置

---

**创建时间**：2026-01-03
**适用版本**：Claude Code CLI
**更新频率**：根据实践经验持续更新
