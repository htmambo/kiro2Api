# Provider æž¶æž„ç®€åŒ–æ–¹æ¡ˆ

**åˆ›å»ºæ—¶é—´**ï¼š2026-01-03
**ç›®æ ‡**ï¼šç®€åŒ– provider æŠ½è±¡å±‚ï¼Œä¿ç•™è´¦å·æ± è´Ÿè½½å‡è¡¡åŠŸèƒ½

---

## ðŸ“‹ èƒŒæ™¯ä¸Žç›®æ ‡

### å½“å‰çŠ¶å†µ
- é¡¹ç›®åªä½¿ç”¨ä¸€ä¸ª provider ç±»åž‹ï¼š`claude-kiro-oauth`
- Provider å±‚å®žé™…ä¸Šæ˜¯"è´¦å·/å‡­æ®å®žä¾‹"çš„åˆ†ç»„å®¹å™¨
- å¤š provider æ”¯æŒçš„ä»£ç å·²ç»é€€åŒ–ä¸ºå¸¸é‡

### ç®€åŒ–ç›®æ ‡
1. **ç§»é™¤ä¸å¿…è¦çš„ provider æŠ½è±¡**ï¼šå›ºå®šä¸ºå•ä¸€ç±»åž‹
2. **ä¿ç•™è´¦å·æ± åŠŸèƒ½**ï¼šå¤šè´¦å·è´Ÿè½½å‡è¡¡ã€å¥åº·æ£€æŸ¥ã€é”™è¯¯å¤„ç†
3. **ç®€åŒ–é…ç½®ç»“æž„**ï¼šå‡å°‘åµŒå¥—å±‚çº§
4. **é™ä½Žç»´æŠ¤æˆæœ¬**ï¼šå‡å°‘ä»£ç å¤æ‚åº¦

---

## ðŸ” å½“å‰æž¶æž„åˆ†æž

### Provider çš„æœ¬è´¨

æ ¹æ® Codex åˆ†æžï¼Œå½“å‰çš„ "provider" å®žé™…ä¸Šæ˜¯ï¼š

```
Provider (claude-kiro-oauth)
  â””â”€â”€ Account 1 (uuid-1, creds-file-1)
  â””â”€â”€ Account 2 (uuid-2, creds-file-2)
  â””â”€â”€ Account 3 (uuid-3, creds-file-3)
```

**å…³é”®å‘çŽ°**ï¼š
- `providerType` åªæ˜¯ä¸€ä¸ªåˆ†ç»„æ ‡è¯†ï¼Œå®žé™…åªæœ‰ä¸€ä¸ªå€¼
- çœŸæ­£çš„è´Ÿè½½å‡è¡¡å•ä½æ˜¯ `uuid`ï¼ˆè´¦å·ï¼‰
- æ¯ä¸ªè´¦å·å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ `KiroService` å®žä¾‹

### å½“å‰é…ç½®ç»“æž„

```json
// configs/provider_pools.json
{
  "claude-kiro-oauth": [
    {
      "uuid": "account-1",
      "KIRO_OAUTH_CREDS_FILE_PATH": "iro/token-1.json",
      "isHealthy": true,
      "errorCount": 0,
      "usageCount": 100
    }
  ]
}
```

### æ¶‰åŠçš„æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ | æ”¹åŠ¨å¿…è¦æ€§ |
|------|------|-----------|
| `src/provider-pool-manager.js` | è´¦å·æ± ç®¡ç†ï¼ˆJSON æ¨¡å¼ï¼‰ | å¿…é¡» |
| `src/sqlite-provider-pool-manager.js` | è´¦å·æ± ç®¡ç†ï¼ˆSQLite æ¨¡å¼ï¼‰ | å¿…é¡» |
| `src/service-manager.js` | è´¦å·é€‰æ‹©ä¸Žé€‚é…å™¨åˆ›å»º | å¿…é¡» |
| `src/config-manager.js` | é…ç½®åŠ è½½ | å¿…é¡» |
| `src/ui-manager.js` | UI APIï¼ˆæŒ‰ providerType åˆ†ç»„ï¼‰ | å¯é€‰ |
| `src/common.js` | è¯·æ±‚é‡è¯•é€»è¾‘ | å¿…é¡» |
| `src/request-handler.js` | Provider è¦†ç›–å…¥å£ | å¯é€‰ |
| `configs/provider_pools.json` | é…ç½®æ–‡ä»¶ | å¿…é¡» |

---

## ðŸ’¡ ç®€åŒ–æ–¹æ¡ˆï¼ˆæŽ¨èï¼‰

### æ–¹æ¡ˆ Aï¼šæ¸è¿›å¼ç®€åŒ–ï¼ˆæŽ¨èï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šä¿æŒå†…éƒ¨ç»“æž„ï¼Œç®€åŒ–å¤–éƒ¨é…ç½®å’Œ API

#### é˜¶æ®µ 1ï¼šé…ç½®æ‰å¹³åŒ–

**ç›®æ ‡**ï¼šç§»é™¤ providerType åµŒå¥—ï¼Œç›´æŽ¥ä½¿ç”¨è´¦å·æ•°ç»„

**é…ç½®å˜æ›´**ï¼š
```json
// æ—§æ ¼å¼ï¼ˆä¿æŒå…¼å®¹ï¼‰
{
  "claude-kiro-oauth": [
    { "uuid": "account-1", ... }
  ]
}

// æ–°æ ¼å¼ï¼ˆæŽ¨èï¼‰
{
  "accounts": [
    { "uuid": "account-1", ... }
  ]
}

// æˆ–è€…æ›´ç®€æ´
[
  { "uuid": "account-1", ... }
]
```

**ä»£ç æ”¹åŠ¨**ï¼š
- `src/config-manager.js` - æ”¯æŒä¸¤ç§æ ¼å¼ï¼Œè‡ªåŠ¨è½¬æ¢
- å†…éƒ¨ä»ä½¿ç”¨ `providerType` å¸¸é‡ï¼Œé¿å…å¤§è§„æ¨¡é‡æž„

**ä¼˜ç‚¹**ï¼š
- âœ… é…ç½®æ›´ç®€æ´
- âœ… æ”¹åŠ¨æœ€å°
- âœ… ä¿æŒå‘åŽå…¼å®¹
- âœ… ä¸å½±å“ SQLite schema

**å·¥ä½œé‡**ï¼š2-3 å°æ—¶

---

#### é˜¶æ®µ 2ï¼šå›ºå®š providerType ä¸ºå¸¸é‡

**ç›®æ ‡**ï¼šç§»é™¤ providerType å‚æ•°ä¼ é€’

**ä»£ç æ”¹åŠ¨**ï¼š
```javascript
// æ—§ä»£ç 
providerPoolManager.selectProvider(providerType, requestedModel)

// æ–°ä»£ç 
providerPoolManager.selectAccount(requestedModel)
// å†…éƒ¨å›ºå®š providerType = 'claude-kiro-oauth'
```

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `src/provider-pool-manager.js` - ç§»é™¤ providerType å‚æ•°
- `src/sqlite-provider-pool-manager.js` - åŒä¸Š
- `src/service-manager.js` - ç®€åŒ–è´¦å·é€‰æ‹©é€»è¾‘
- `src/common.js` - ç®€åŒ–é‡è¯•é€»è¾‘

**ä¼˜ç‚¹**ï¼š
- âœ… ä»£ç æ›´æ¸…æ™°
- âœ… å‡å°‘å‚æ•°ä¼ é€’
- âœ… é™ä½Žå‡ºé”™å¯èƒ½

**å·¥ä½œé‡**ï¼š4-6 å°æ—¶

---

#### é˜¶æ®µ 3ï¼šUI API ç®€åŒ–ï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**ï¼šUI è¿”å›žæ‰å¹³çš„è´¦å·åˆ—è¡¨

**API å˜æ›´**ï¼š
```javascript
// æ—§æ ¼å¼
{
  "claude-kiro-oauth": {
    "accounts": [...],
    "_accountPoolStats": {...}
  }
}

// æ–°æ ¼å¼
{
  "accounts": [...],
  "stats": {...}
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… API æ›´ç®€æ´
- âœ… å‰ç«¯ä»£ç æ›´ç®€å•

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦åŒæ­¥æ›´æ–°å‰ç«¯ä»£ç 

**å·¥ä½œé‡**ï¼š2-3 å°æ—¶

---

### æ–¹æ¡ˆ Bï¼šå½»åº•é‡æž„ï¼ˆä¸æŽ¨èï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šå®Œå…¨ç§»é™¤ provider æŠ½è±¡ï¼Œé‡å‘½åæ‰€æœ‰ç›¸å…³ä»£ç 

**æ”¹åŠ¨èŒƒå›´**ï¼š
- é‡å‘½å `ProviderPoolManager` â†’ `AccountPoolManager`
- ç§»é™¤æ‰€æœ‰ `providerType` å‚æ•°
- ä¿®æ”¹ SQLite schemaï¼ˆéœ€è¦æ•°æ®è¿ç§»ï¼‰
- é‡å†™ UI API

**ä¼˜ç‚¹**ï¼š
- âœ… æž¶æž„æœ€æ¸…æ™°
- âœ… è¯­ä¹‰æœ€å‡†ç¡®

**ç¼ºç‚¹**ï¼š
- âŒ æ”¹åŠ¨é¢å·¨å¤§ï¼ˆ20+ æ–‡ä»¶ï¼‰
- âŒ éœ€è¦æ•°æ®è¿ç§»
- âŒ é£Žé™©é«˜
- âŒ æµ‹è¯•å·¥ä½œé‡å¤§

**å·¥ä½œé‡**ï¼š2-3 å¤©

**ç»“è®º**ï¼šä¸æŽ¨èï¼Œæ”¶ç›Šä¸Žæˆæœ¬ä¸æˆæ­£æ¯”

---

## ðŸ“ æŽ¨èå®žæ–½è®¡åˆ’

### ç¬¬ä¸€æ­¥ï¼šé…ç½®æ‰å¹³åŒ–ï¼ˆç«‹å³å¯åšï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
1. `src/config-manager.js` - æ”¯æŒæ–°æ—§ä¸¤ç§é…ç½®æ ¼å¼
2. `configs/provider_pools.json` - è¿ç§»åˆ°æ–°æ ¼å¼

**å®žæ–½æ­¥éª¤**ï¼š
```javascript
// src/config-manager.js
function loadProviderPools(filePath) {
    const data = JSON.parse(fs.readFileSync(filePath));

    // æ”¯æŒä¸‰ç§æ ¼å¼
    if (Array.isArray(data)) {
        // æ ¼å¼ 1: ç›´æŽ¥æ•°ç»„
        return { 'claude-kiro-oauth': data };
    } else if (data.accounts) {
        // æ ¼å¼ 2: { accounts: [...] }
        return { 'claude-kiro-oauth': data.accounts };
    } else {
        // æ ¼å¼ 3: æ—§æ ¼å¼ { "claude-kiro-oauth": [...] }
        return data;
    }
}
```

**é…ç½®è¿ç§»**ï¼š
```bash
# å¤‡ä»½æ—§é…ç½®
cp configs/provider_pools.json configs/provider_pools.json.backup

# ä½¿ç”¨æ–°æ ¼å¼
cat > configs/provider_pools.json <<'EOF'
{
  "accounts": [
    {
      "uuid": "account-1",
      "KIRO_OAUTH_CREDS_FILE_PATH": "configs/kiro/token-1.json"
    }
  ]
}
EOF
```

**éªŒè¯**ï¼š
- å¯åŠ¨æœåŠ¡ï¼Œç¡®è®¤è´¦å·æ± æ­£å¸¸åŠ è½½
- æµ‹è¯•è¯·æ±‚ï¼Œç¡®è®¤è´Ÿè½½å‡è¡¡æ­£å¸¸
- æ£€æŸ¥ UIï¼Œç¡®è®¤è´¦å·åˆ—è¡¨æ˜¾ç¤ºæ­£å¸¸

---

### ç¬¬äºŒæ­¥ï¼šå›ºå®š providerTypeï¼ˆå¯é€‰ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
1. `src/provider-pool-manager.js`
2. `src/sqlite-provider-pool-manager.js`
3. `src/service-manager.js`
4. `src/common.js`

**æ ¸å¿ƒæ”¹åŠ¨**ï¼š
```javascript
// å®šä¹‰å¸¸é‡
const DEFAULT_PROVIDER_TYPE = 'claude-kiro-oauth';

// ç®€åŒ–æ–¹æ³•ç­¾å
class ProviderPoolManager {
    // æ—§ï¼šselectProvider(providerType, requestedModel, options)
    // æ–°ï¼šselectAccount(requestedModel, options)
    selectAccount(requestedModel, options = {}) {
        const providerType = DEFAULT_PROVIDER_TYPE;
        // ... åŽŸæœ‰é€»è¾‘
    }
}
```

**éªŒè¯**ï¼š
- è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
- å¤šå®žä¾‹å¹¶å‘æµ‹è¯•
- UI åŠŸèƒ½æµ‹è¯•

---

### ç¬¬ä¸‰æ­¥ï¼šæ–‡æ¡£æ›´æ–°

**éœ€è¦æ›´æ–°çš„æ–‡æ¡£**ï¼š
1. `README.md` - é…ç½®è¯´æ˜Ž
2. `docs/json-storage-issues-analysis.md` - æ›´æ–°æ–‡ä»¶è·¯å¾„è¯´æ˜Ž
3. `docs/sqlite-implementation-analysis.md` - æ›´æ–°è¡¨ç»“æž„è¯´æ˜Ž
4. éƒ¨ç½²æ–‡æ¡£ - é…ç½®ç¤ºä¾‹

---

## âš ï¸ é£Žé™©ä¸Žæ³¨æ„äº‹é¡¹

### 1. é…ç½®å…¼å®¹æ€§

**é£Žé™©**ï¼šæ—§é…ç½®æ ¼å¼å¤±æ•ˆ

**ç¼“è§£æŽªæ–½**ï¼š
- ä¿æŒå‘åŽå…¼å®¹ï¼Œæ”¯æŒæ—§æ ¼å¼
- æä¾›é…ç½®è¿ç§»è„šæœ¬
- åœ¨æ—¥å¿—ä¸­æç¤ºä½¿ç”¨æ—§æ ¼å¼

### 2. UI ä¾èµ–

**é£Žé™©**ï¼šå‰ç«¯ä»£ç ä¾èµ– providerType ç»“æž„

**ç¼“è§£æŽªæ–½**ï¼š
- å…ˆåšåŽç«¯å…¼å®¹ï¼Œä¿æŒ API ä¸å˜
- é€æ­¥è¿ç§»å‰ç«¯ä»£ç 
- æä¾›è¿‡æ¸¡æœŸ

### 3. SQLite æ•°æ®

**é£Žé™©**ï¼šçŽ°æœ‰æ•°æ®åº“ä¸­çš„ provider_type å­—æ®µ

**ç¼“è§£æŽªæ–½**ï¼š
- ä¸ä¿®æ”¹ schemaï¼Œä¿æŒ provider_type åˆ—
- å›ºå®šå†™å…¥ 'claude-kiro-oauth'
- æŸ¥è¯¢æ—¶å¯ä»¥å¿½ç•¥è¯¥å­—æ®µ

### 4. å¤šå®žä¾‹éƒ¨ç½²

**é£Žé™©**ï¼šé…ç½®æ–‡ä»¶åŒæ­¥é—®é¢˜

**ç¼“è§£æŽªæ–½**ï¼š
- ä½¿ç”¨ SQLite æ¨¡å¼ï¼ˆæŽ¨èï¼‰
- æˆ–ä½¿ç”¨å…±äº«é…ç½®æ–‡ä»¶
- é¿å…æ‰‹åŠ¨ç¼–è¾‘è¿è¡Œæ—¶é…ç½®

---

## ðŸ“Š æ”¶ç›Šè¯„ä¼°

### é…ç½®ç®€åŒ–ï¼ˆé˜¶æ®µ 1ï¼‰

| æŒ‡æ ‡ | æ”¹è¿› |
|------|------|
| é…ç½®æ–‡ä»¶è¡Œæ•° | -20% |
| é…ç½®åµŒå¥—å±‚çº§ | -1 å±‚ |
| æ–°æ‰‹ç†è§£æˆæœ¬ | -30% |
| å·¥ä½œé‡ | 2-3 å°æ—¶ |

### ä»£ç ç®€åŒ–ï¼ˆé˜¶æ®µ 2ï¼‰

| æŒ‡æ ‡ | æ”¹è¿› |
|------|------|
| å‡½æ•°å‚æ•°æ•°é‡ | -1 ä¸ª |
| ä»£ç è¡Œæ•° | -5% |
| ç»´æŠ¤æˆæœ¬ | -15% |
| å·¥ä½œé‡ | 4-6 å°æ—¶ |

### æ€»ä½“æ”¶ç›Š

- âœ… **é…ç½®æ›´ç®€æ´**ï¼šå‡å°‘ 20% é…ç½®ä»£ç 
- âœ… **ä»£ç æ›´æ¸…æ™°**ï¼šå‡å°‘ä¸å¿…è¦çš„æŠ½è±¡
- âœ… **ç»´æŠ¤æ›´å®¹æ˜“**ï¼šå‡å°‘ 15% ç»´æŠ¤æˆæœ¬
- âœ… **é£Žé™©å¯æŽ§**ï¼šæ¸è¿›å¼æ”¹è¿›ï¼Œæ¯æ­¥å¯éªŒè¯

---

## ðŸŽ¯ æŽ¨èè¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆé˜¶æ®µ 1ï¼‰

```
è¯·å®žæ–½é…ç½®æ‰å¹³åŒ–æ–¹æ¡ˆï¼š

1. ä¿®æ”¹ src/config-manager.js æ”¯æŒæ–°é…ç½®æ ¼å¼
2. è¿ç§» configs/provider_pools.json åˆ°æ–°æ ¼å¼
3. æµ‹è¯•éªŒè¯

è¦æ±‚ï¼š
- ä¿æŒå‘åŽå…¼å®¹
- æ·»åŠ é…ç½®æ ¼å¼æ£€æµ‹å’Œè­¦å‘Š
- æ›´æ–°ç›¸å…³æ–‡æ¡£

ä½ æœ‰å®Œå…¨çš„ä»£ç ä¿®æ”¹æƒé™ï¼Œç›´æŽ¥æ‰§è¡Œã€‚
```

### åŽç»­è€ƒè™‘ï¼ˆé˜¶æ®µ 2ï¼‰

åœ¨é˜¶æ®µ 1 ç¨³å®šè¿è¡Œ 1-2 å‘¨åŽï¼Œå†è€ƒè™‘å›ºå®š providerType ä¸ºå¸¸é‡ã€‚

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [SQLite å®žçŽ°åˆ†æž](./sqlite-implementation-analysis.md) - Provider åœ¨ SQLite ä¸­çš„å®žçŽ°
- [JSON å­˜å‚¨é—®é¢˜åˆ†æž](./json-storage-issues-analysis.md) - Provider pools æ–‡ä»¶åˆ†æž
- [æ‰§è¡ŒæŠ¥å‘Š](./EXECUTION_REPORT.md) - æœ€è¿‘çš„ä¼˜åŒ–è®°å½•

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åŽæ›´æ–°**ï¼š2026-01-03
**çŠ¶æ€**ï¼šå¾…å®žæ–½
